name: Publish documentation to GitHub pages 📝

on:
  push:
    tags:
      - '*'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Git SSH
        run: |
          mkdir C:\Users\runneradmin\.ssh
          echo "$env:SSH_PRIVATE_KEY" > C:\Users\runneradmin\.ssh\id_rsa
          chmod 600 C:\Users\runneradmin\.ssh\id_rsa
          Start-Process ssh-agent -Verb RunAs
          Start-Process ssh-add C:\Users\runneradmin\.ssh\id_rsa
          ssh-keyscan -H github.com >> C:\Users\runneradmin\.ssh\known_hosts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - run: |
          python -m pip install --upgrade pip build
          --index-url=https://blpapi.bloomberg.com/repository/releases/python/simple blpapi
          pip install -r requirements.txt

      - run: pdoc --html charting/ --output-dir docs/ --template-dir docs/templates --force

      - uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  publish:
    needs: generate
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: documentation
      url: "${{ steps.deployment.outputs.page_url }}/charting"
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4