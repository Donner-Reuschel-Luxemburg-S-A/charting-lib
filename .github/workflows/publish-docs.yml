name: Publish documentation to GitHub pages 📝

on:
  push:
    tags:
      - '*'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Set up Git SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - run: |
          sudo apt-get update -y
          sudo apt-get install -y libmariadb-dev
          python -m pip install --upgrade pip build
          pip install pypiwin32
          pip install --index-url=https://bcms.bloomberg.com/pip/simple blpapi
          if [ -f requirements.txt ]; then pip install -r requirements.txt --force; fi

      - run: pdoc --html charting/ --output-dir docs/ --template-dir docs/templates --force

      - uses: actions/upload-pages-artifact@v1
        with:
          path: docs/

  publish:
    needs: generate
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: documentation
      url: "${{ steps.deployment.outputs.page_url }}/charting"
    steps:
      - id: deployment
        uses: actions/deploy-pages@v2